version: 2.1

jobs:
  test:
    docker:
      - image: cimg/node:12.19
    steps:
      - checkout
      - run: node --version
      - run: npm --version
      - restore_cache:
          keys:
            - node-deps-v1-{{ arch }}-{{ .Branch }}-{{checksum "package.json"}}-{{checksum "examples/package.json"}}-{{checksum "sandbox/package.json"}}-{{checksum "sandbox_simple/package.json"}}
            - node-deps-v1-{{ arch }}-{{ .Branch }}-{{checksum "package.json"}}
      - run:
          name: Install
          command: npm run install-all
      - save_cache:
          key: node-deps-v1-{{ arch }}-{{ .Branch }}-{{checksum "package.json"}}-{{checksum "examples/package.json"}}-{{checksum "sandbox/package.json"}}-{{checksum "sandbox_simple/package.json"}}
          paths:
            - node_modules
            - examples/node_modules
            - sandbox/node_modules
            - sandbox_simple/node_modules
      - run:
          # Fixes an issue where the max file watch count is exceeded, triggering ENOSPC
          # https://stackoverflow.com/questions/22475849/node-js-error-enospc#32600959
          name: Env
          command: echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf && sudo sysctl -p
      - run:
          name: Lint
          command: npm run lint
      - run:
          name: Test
          command: npm run test
      - store_test_results:
          path: ./junit
      - store_artifacts:
          path: ./junit
      - store_artifacts:
          path: ./coverage/lconv
      - store_artifacts:
          path: ./coverage/html
      - run:
          name: Build
          command: npm run build-all
      - run:
          name: Hot
          command: npm run check-hot

workflows:
  build-and-test:
    jobs:
      - test
